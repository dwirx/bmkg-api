name: Publish npm

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Build package (includes base.json/base.csv copy)
              run: bun run build

            - name: Publish to npm
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
              run: npm publish --access public

            - name: Read package version
              id: pkg
              run: echo "PKG_VERSION=$(node -p \"require('./package.json').version\")" >> $GITHUB_ENV

            - name: Create GitHub Release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: v${{ env.PKG_VERSION }}
                  draft: false
                  prerelease: false
                  body: |
                      Automated release for bmkg-api v${{ env.PKG_VERSION }}.
                      - npm publish via workflow
                      - includes base.csv/base.json assets in package
